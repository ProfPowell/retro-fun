<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vibe Code Racer // Cyber Viber Ninja</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0a0a;--fg:#33ff33;--dim:#0a3a0a;--accent:#00ffff;--alt:#ff00ff;
  --panel-bg:#0d0d0d;--input-bg:#0a0a0a;--border:#1a3a1a;
  --scanline:rgba(0,0,0,0.15);--glow-color:#33ff33;
  --debt-low:#33ff33;--debt-mod:#ffff00;--debt-high:#ff8800;--debt-crit:#ff3333;
}
body{background:var(--bg);color:var(--fg);font-family:'Courier New',monospace;height:100vh;overflow:hidden;display:flex;flex-direction:column}
#scanlines{position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,var(--scanline) 2px,var(--scanline) 4px);pointer-events:none;z-index:9999}
#crt-flicker{position:fixed;inset:0;pointer-events:none;z-index:9998;animation:crt-flick 0.05s infinite}
@keyframes crt-flick{0%,100%{opacity:0}50%{opacity:0.015}}

/* TOP BAR */
#top-bar{height:24px;display:flex;align-items:center;padding:0 8px;background:#080808;border-bottom:1px solid var(--border);flex-shrink:0;z-index:10}
#top-bar a{color:var(--dim);text-decoration:none;font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase}
#top-bar a:hover{color:var(--fg);text-shadow:0 0 6px var(--fg)}

/* HUD */
#hud{height:36px;display:flex;align-items:center;gap:12px;padding:0 10px;background:#080808;border-bottom:1px solid var(--border);flex-shrink:0;font-size:0.6rem;text-transform:uppercase;letter-spacing:0.08em;overflow-x:auto;white-space:nowrap}
.hud-item{display:flex;align-items:center;gap:4px}
.hud-label{color:#555}
.hud-val{color:var(--accent);text-shadow:0 0 6px var(--accent)}
.hud-val.money{color:var(--alt);text-shadow:0 0 6px var(--alt)}
.hud-val.agents{color:#ffff00;text-shadow:0 0 6px #ffff00}

/* MAIN AREA */
#main{flex:1;display:flex;overflow:hidden;position:relative}

/* CODE PANEL */
#code-panel{flex:0 0 65%;display:flex;flex-direction:column;border-right:1px solid var(--border);overflow:hidden;position:relative}
#code-scroll{flex:1;overflow-y:auto;padding:8px 10px;font-size:0.7rem;line-height:1.5}
#code-scroll::-webkit-scrollbar{width:4px}
#code-scroll::-webkit-scrollbar-track{background:#080808}
#code-scroll::-webkit-scrollbar-thumb{background:var(--dim)}
.code-line{opacity:0;animation:line-in 0.15s forwards;white-space:pre-wrap;word-break:break-all}
@keyframes line-in{to{opacity:1}}
.kw{color:var(--accent)}
.str{color:var(--alt)}
.cmt{color:#1a6a1a}
.num{color:#ffff00}
.fn{color:#33ff33}
.line-num{color:#333;margin-right:8px;user-select:none}

/* CONTROL PANEL */
#ctrl-panel{flex:1;display:flex;flex-direction:column;gap:0;overflow-y:auto;padding:0}
.ctrl-section{padding:8px 10px;border-bottom:1px solid var(--border)}
.ctrl-title{font-size:0.55rem;text-transform:uppercase;letter-spacing:0.15em;color:#555;margin-bottom:6px}

/* DEBT METER */
#debt-bar-wrap{height:14px;background:#111;border:1px solid var(--border);position:relative;margin-bottom:4px}
#debt-bar{height:100%;width:0;transition:width 0.3s,background 0.3s}
#debt-label{font-size:0.6rem;color:var(--debt-low)}
#debt-pct{font-size:0.55rem;float:right;color:#555}
.debt-critical #debt-bar-wrap{animation:debt-pulse 0.5s infinite}
@keyframes debt-pulse{0%,100%{box-shadow:0 0 8px var(--debt-crit)}50%{box-shadow:0 0 20px var(--debt-crit)}}
#refactor-btn{margin-top:6px;width:100%;padding:4px;background:transparent;border:1px solid var(--border);color:var(--fg);font-family:inherit;font-size:0.55rem;text-transform:uppercase;letter-spacing:0.1em;cursor:pointer}
#refactor-btn:hover{border-color:var(--fg);text-shadow:0 0 6px var(--fg)}
#refactor-btn.active{background:var(--dim);color:#fff;border-color:var(--fg);animation:refactor-glow 1s infinite}
@keyframes refactor-glow{0%,100%{box-shadow:0 0 4px var(--fg)}50%{box-shadow:0 0 12px var(--fg)}}

/* AGENT SECTION */
#deploy-btn{width:100%;padding:4px;background:transparent;border:1px solid var(--border);color:#ffff00;font-family:inherit;font-size:0.55rem;text-transform:uppercase;letter-spacing:0.1em;cursor:pointer;margin-bottom:4px}
#deploy-btn:hover{border-color:#ffff00;text-shadow:0 0 6px #ffff00}
#deploy-btn:disabled{opacity:0.3;cursor:default}
#agent-count{font-size:0.6rem;color:#ffff00}
#autopilot-status{font-size:0.55rem;color:#555;margin-top:2px}
.autopilot-on{color:var(--fg)!important;text-shadow:0 0 6px var(--fg)}

/* STATS */
.stat-row{font-size:0.6rem;display:flex;justify-content:space-between;margin-bottom:2px}
.stat-val{color:var(--accent)}

/* INPUT BAR */
#input-bar{height:36px;display:flex;align-items:center;padding:0 8px;background:#080808;border-top:1px solid var(--border);flex-shrink:0}
#input-bar label{font-size:0.6rem;color:var(--dim);margin-right:6px;white-space:nowrap}
#prompt-input{flex:1;background:transparent;border:none;color:var(--fg);font-family:inherit;font-size:0.65rem;outline:none;caret-color:var(--fg)}
#prompt-input::placeholder{color:#1a3a1a}
#prompt-input:disabled{opacity:0.3}

/* OVERLAYS */
.overlay{position:fixed;inset:0;z-index:100;display:flex;align-items:center;justify-content:center;flex-direction:column;background:var(--bg)}
.overlay.hidden{display:none}

/* BOOT */
#boot-overlay{font-size:0.65rem;align-items:flex-start;justify-content:flex-start;padding:20px;overflow:hidden}
#boot-overlay .boot-line{margin-bottom:2px;opacity:0}
#boot-overlay .boot-line.show{opacity:1}
.boot-ok{color:var(--fg)}
.boot-warn{color:#ffff00}
.boot-err{color:#ff3333}
.boot-dim{color:#555}

/* MODE SELECT */
#mode-overlay{font-size:0.7rem;gap:8px}
#mode-overlay .mode-title{font-size:1rem;color:var(--accent);text-shadow:0 0 10px var(--accent);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.2em}
.mode-box{border:1px solid var(--border);padding:10px 16px;width:340px;cursor:pointer;transition:all 0.2s}
.mode-box:hover,.mode-box.sel{border-color:var(--accent);color:var(--accent);text-shadow:0 0 6px var(--accent);background:#0a1a1a}
.mode-box .mode-key{color:var(--alt);margin-right:6px}
.mode-box .mode-desc{font-size:0.55rem;color:#555;display:block;margin-top:2px}

/* POLECAT FLASH */
#polecat-overlay{background:rgba(0,0,0,0.9);z-index:200}
#polecat-overlay .flash-text{font-size:1.6rem;color:#ffaa00;text-shadow:0 0 20px #ffaa00,0 0 40px #ff6600;text-transform:uppercase;letter-spacing:0.15em;animation:polecat-pulse 0.3s infinite}
@keyframes polecat-pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}

/* GAS TOWN COUNTDOWN */
#gastown-overlay{background:rgba(0,0,0,0.9);z-index:200}
#gastown-overlay .gas-label{font-size:0.7rem;color:#555;text-transform:uppercase;letter-spacing:0.2em;margin-bottom:10px}
#gastown-overlay .gas-num{font-size:3rem;color:var(--accent);text-shadow:0 0 20px var(--accent);animation:gas-scale 1s ease-out}
@keyframes gas-scale{0%{transform:scale(2);opacity:0}50%{opacity:1}100%{transform:scale(1)}}

/* VICTORY */
#victory-overlay{background:rgba(0,0,0,0.95);z-index:200;text-align:center;gap:12px}
#victory-overlay .victory-title{font-size:1.4rem;text-transform:uppercase;letter-spacing:0.2em;background:linear-gradient(90deg,#ff0000,#ff8800,#ffff00,#33ff33,#00ffff,#ff00ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:rainbow-shift 2s linear infinite;background-size:200% 100%}
@keyframes rainbow-shift{0%{background-position:0% 50%}100%{background-position:200% 50%}}
#victory-overlay .victory-stat{font-size:0.65rem;color:var(--accent)}
#victory-overlay .victory-btn{margin-top:10px;padding:6px 16px;background:transparent;border:1px solid var(--accent);color:var(--accent);font-family:inherit;font-size:0.6rem;text-transform:uppercase;cursor:pointer;letter-spacing:0.1em}
#victory-overlay .victory-btn:hover{background:var(--accent);color:var(--bg)}

/* FAILURE */
#failure-overlay{background:#0a0000;z-index:200;text-align:center;gap:10px}
#failure-overlay .fail-title{font-size:1.4rem;color:#ff3333;text-shadow:0 0 20px #ff3333;text-transform:uppercase;letter-spacing:0.2em;animation:fail-glitch 0.15s infinite}
@keyframes fail-glitch{0%{transform:translate(0)}25%{transform:translate(-3px,2px)}50%{transform:translate(2px,-1px)}75%{transform:translate(-1px,-2px)}100%{transform:translate(0)}}
#failure-overlay .fail-art{font-size:0.5rem;color:#ff3333;opacity:0.7;white-space:pre;line-height:1.2}
#failure-overlay .fail-stat{font-size:0.6rem;color:#ff6666}
#failure-overlay .fail-btn{margin-top:10px;padding:6px 16px;background:transparent;border:1px solid #ff3333;color:#ff3333;font-family:inherit;font-size:0.6rem;text-transform:uppercase;cursor:pointer;letter-spacing:0.1em}
#failure-overlay .fail-btn:hover{background:#ff3333;color:#000}

/* SYS FLASH */
#sys-flash{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:150;font-size:0.65rem;color:#ffff00;text-shadow:0 0 10px #ffff00,0 0 20px #ffff00;text-transform:uppercase;letter-spacing:0.12em;pointer-events:none;opacity:0;transition:opacity 0.2s;text-align:center;max-width:80vw;padding:8px 16px;background:rgba(0,0,0,0.8);border:1px solid #ffff0044}
#sys-flash.show{opacity:1}

/* WAIT OVERLAY (free mode) */
#wait-overlay{background:rgba(0,0,0,0.9);z-index:200;text-align:center;gap:8px}
#wait-overlay .wait-title{font-size:0.8rem;color:#ffff00;text-transform:uppercase;letter-spacing:0.15em}
#wait-overlay .wait-timer{font-size:2rem;color:var(--accent);text-shadow:0 0 15px var(--accent)}
#wait-overlay .wait-sub{font-size:0.55rem;color:#555}

@media(max-width:768px){
  #main{flex-direction:column}
  #code-panel{flex:0 0 50%;border-right:none;border-bottom:1px solid var(--border)}
  #ctrl-panel{flex:1}
  #hud{font-size:0.5rem;gap:8px}
}
</style>
</head>
<body>

<div id="scanlines"></div>
<div id="crt-flicker"></div>

<div id="top-bar">
  <a href="../../">&#9664; Back</a>
</div>

<div id="hud">
  <div class="hud-item"><span class="hud-label">MODE:</span><span class="hud-val" id="hud-mode">---</span></div>
  <div class="hud-item"><span class="hud-label">TIME:</span><span class="hud-val" id="hud-time">00:00</span></div>
  <div class="hud-item"><span class="hud-label">LOC:</span><span class="hud-val" id="hud-loc">0</span></div>
  <div class="hud-item"><span class="hud-label">TOKENS:</span><span class="hud-val" id="hud-tokens">0</span></div>
  <div class="hud-item"><span class="hud-label">$:</span><span class="hud-val money" id="hud-money">$0</span></div>
  <div class="hud-item"><span class="hud-label">AGENTS:</span><span class="hud-val agents" id="hud-agents">0/16</span></div>
</div>

<div id="main">
  <div id="code-panel">
    <div id="code-scroll"></div>
  </div>
  <div id="ctrl-panel">
    <div class="ctrl-section" id="debt-section">
      <div class="ctrl-title">Technical Debt</div>
      <div id="debt-bar-wrap"><div id="debt-bar"></div></div>
      <div><span id="debt-label">LOW</span><span id="debt-pct">0%</span></div>
      <button id="refactor-btn">[ Refactor ]</button>
    </div>
    <div class="ctrl-section">
      <div class="ctrl-title">Agent Deploy</div>
      <button id="deploy-btn">[ Deploy Agent — $500 ]</button>
      <div id="agent-count">Agents: 0 / 16</div>
      <div id="autopilot-status">AUTOPILOT: OFF</div>
    </div>
    <div class="ctrl-section">
      <div class="ctrl-title">Session Stats</div>
      <div class="stat-row"><span>LOC/sec</span><span class="stat-val" id="stat-locsec">0</span></div>
      <div class="stat-row"><span>Prompts</span><span class="stat-val" id="stat-prompts">0</span></div>
      <div class="stat-row"><span>Peak LOC/s</span><span class="stat-val" id="stat-peak">0</span></div>
      <div class="stat-row"><span>Best Time</span><span class="stat-val" id="stat-best">--:--</span></div>
    </div>
  </div>
</div>

<div id="input-bar">
  <label for="prompt-input">vibes&gt;</label>
  <input id="prompt-input" type="text" placeholder="type a prompt and hit enter..." autocomplete="off" disabled>
</div>

<!-- OVERLAYS -->
<div id="boot-overlay" class="overlay"></div>
<div id="mode-overlay" class="overlay hidden"></div>
<div id="polecat-overlay" class="overlay hidden"></div>
<div id="gastown-overlay" class="overlay hidden"></div>
<div id="victory-overlay" class="overlay hidden"></div>
<div id="failure-overlay" class="overlay hidden"></div>
<div id="wait-overlay" class="overlay hidden"></div>
<div id="sys-flash"></div>

<script>
/* ===== STATE ===== */
const S = {
  phase: 'boot', // boot, modeselect, playing, victory, failure, waiting
  mode: null,    // race, unlimited, free, startup
  loc: 0,
  displayLoc: 0,
  tokens: 0,
  money: 0,
  agents: 0,
  debt: 0,
  debtLevel: 'LOW',
  startTime: 0,
  elapsed: 0,
  refactoring: false,
  autopilot: false,
  promptCount: 0,
  lineNum: 1,
  peakLocSec: 0,
  locLastSec: 0,
  locSecTimer: 0,
  lastFrameTime: 0,
  agentAccum: 0,
  flashTimer: null,
  waitTime: 0,
  freeRefreshes: 0,
  gameOver: false
};

/* ===== MODE CONFIG ===== */
const MODES = {
  race:      { tokens: 5000,  money: 10000, tokenPerPrompt: 15, tokenPerLoc: 0.003, moneyDrain: 2, tokenDrain: 0.5, goal: 1000000, label:'RACE' },
  unlimited: { tokens: 3000,  money: 8000,  tokenPerPrompt: 25, tokenPerLoc: 0.008, moneyDrain: 5, tokenDrain: 1.5, goal: Infinity, label:'UNLIMITED' },
  free:      { tokens: 200,   money: 999999,tokenPerPrompt: 10, tokenPerLoc: 0.005, moneyDrain: 0, tokenDrain: 0.3, goal: Infinity, label:'FREE' },
  startup:   { tokens: 10000, money: 50000, tokenPerPrompt: 8,  tokenPerLoc: 0.002, moneyDrain: 8, tokenDrain: 0.8, goal: Infinity, label:'STARTUP' }
};

/* ===== DOM REFS ===== */
const $ = id => document.getElementById(id);
const bootEl = $('boot-overlay'), modeEl = $('mode-overlay'), polecatEl = $('polecat-overlay');
const gastownEl = $('gastown-overlay'), victoryEl = $('victory-overlay'), failureEl = $('failure-overlay');
const waitEl = $('wait-overlay'), sysFlash = $('sys-flash');
const codeScroll = $('code-scroll'), promptInput = $('prompt-input');
const hudMode = $('hud-mode'), hudTime = $('hud-time'), hudLoc = $('hud-loc');
const hudTokens = $('hud-tokens'), hudMoney = $('hud-money'), hudAgents = $('hud-agents');
const debtBar = $('debt-bar'), debtLabel = $('debt-label'), debtPct = $('debt-pct');
const debtSection = $('debt-section'), refactorBtn = $('refactor-btn');
const deployBtn = $('deploy-btn'), agentCount = $('agent-count');
const autopilotStatus = $('autopilot-status');
const statLocSec = $('stat-locsec'), statPrompts = $('stat-prompts');
const statPeak = $('stat-peak'), statBest = $('stat-best');

/* ===== BOOT SEQUENCE ===== */
const BOOT_LINES = [
  { text: 'VIBECORP INDUSTRIES BIOS v4.20.69', cls: 'boot-ok', delay: 200 },
  { text: 'Copyright (c) 2026 VibeCorp International', cls: 'boot-dim', delay: 150 },
  { text: '', cls: 'boot-dim', delay: 100 },
  { text: 'CPU: NVIDIA H200 VIBE TENSOR @ 6.9 GHz', cls: 'boot-ok', delay: 180 },
  { text: 'RAM: 1.21 GIGAVIBES (640K OUGHT TO BE ENOUGH)', cls: 'boot-ok', delay: 180 },
  { text: 'GPU: RTX 5090 Ti FOUNDERS COPILOT EDITION', cls: 'boot-ok', delay: 180 },
  { text: 'VIBE MODULE: DETECTED ....... OK', cls: 'boot-ok', delay: 200 },
  { text: 'LOADING HALLUCINATION ENGINE .... OK', cls: 'boot-ok', delay: 250 },
  { text: 'MOUNTING /dev/vibes ............ OK', cls: 'boot-ok', delay: 200 },
  { text: 'CALIBRATING PROMPT INJECTOR ... OK', cls: 'boot-ok', delay: 200 },
  { text: '', cls: 'boot-dim', delay: 80 },
  { text: 'WARNING: UNIT TESTS NOT FOUND', cls: 'boot-warn', delay: 300 },
  { text: 'WARNING: CODE REVIEW MODULE DISABLED', cls: 'boot-warn', delay: 250 },
  { text: 'WARNING: TECHNICAL DEBT AT PRE-SEED LEVELS', cls: 'boot-warn', delay: 250 },
  { text: 'ERROR: DOCUMENTATION NOT FOUND (VIBES ONLY)', cls: 'boot-err', delay: 300 },
  { text: '', cls: 'boot-dim', delay: 80 },
  { text: 'INITIALIZING AGENT SWARM v16.0 ........ OK', cls: 'boot-ok', delay: 200 },
  { text: 'LOADING TOKEN ECONOMY ................ OK', cls: 'boot-ok', delay: 200 },
  { text: 'CONNECTING TO YEGGE POLECAT MAINFRAME . OK', cls: 'boot-ok', delay: 250 },
  { text: 'DEPLOYING TO PRODUCTION (NO STAGING) .. OK', cls: 'boot-ok', delay: 300 },
  { text: '', cls: 'boot-dim', delay: 100 },
  { text: 'ALL SYSTEMS NOMINAL. VIBES: IMMACULATE.', cls: 'boot-ok', delay: 400 },
  { text: '', cls: 'boot-dim', delay: 100 },
  { text: 'Press any key or click to continue...', cls: 'boot-dim', delay: 200 }
];

function runBoot() {
  bootEl.innerHTML = '';
  let total = 0;
  BOOT_LINES.forEach((l, i) => {
    const div = document.createElement('div');
    div.className = 'boot-line ' + l.cls;
    div.textContent = l.text;
    bootEl.appendChild(div);
    total += l.delay;
    setTimeout(() => div.classList.add('show'), total);
  });
  const dismiss = () => {
    if (S.phase !== 'boot') return;
    S.phase = 'modeselect';
    bootEl.classList.add('hidden');
    showModeSelect();
  };
  setTimeout(() => { if (S.phase === 'boot') dismiss(); }, total + 1500);
  document.addEventListener('keydown', function bk(e) { dismiss(); document.removeEventListener('keydown', bk); });
  document.addEventListener('click', function bc(e) { dismiss(); document.removeEventListener('click', bc); });
}

/* ===== MODE SELECT ===== */
function showModeSelect() {
  modeEl.classList.remove('hidden');
  modeEl.innerHTML = `
    <div class="mode-title">Select Mode</div>
    <div class="mode-box" data-mode="race"><span class="mode-key">[1]</span> RACE — Reach 1M LOC<span class="mode-desc">Tokens: 5,000 | Budget: $10K | Hit 1M LOC or fail trying</span></div>
    <div class="mode-box" data-mode="unlimited"><span class="mode-key">[2]</span> UNLIMITED — Max LOC<span class="mode-desc">Tokens & $ drain aggressively | Out of resources = game over</span></div>
    <div class="mode-box" data-mode="free"><span class="mode-key">[3]</span> FREE — Survive the Frustration<span class="mode-desc">200 tokens, then wait 10s for refresh | Never ends (satirical)</span></div>
    <div class="mode-box" data-mode="startup"><span class="mode-key">[4]</span> STARTUP — Max LOC on Budget<span class="mode-desc">$50K budget | Spend wisely or go broke</span></div>
  `;
  modeEl.querySelectorAll('.mode-box').forEach(b => {
    b.addEventListener('click', () => startGame(b.dataset.mode));
    b.addEventListener('mouseenter', () => { modeEl.querySelectorAll('.mode-box').forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); });
  });
  const keyHandler = e => {
    const map = { '1':'race','2':'unlimited','3':'free','4':'startup' };
    if (map[e.key]) { document.removeEventListener('keydown', keyHandler); startGame(map[e.key]); }
  };
  document.addEventListener('keydown', keyHandler);
}

/* ===== START GAME ===== */
function startGame(mode) {
  const cfg = MODES[mode];
  S.phase = 'playing';
  S.mode = mode;
  S.loc = 0; S.displayLoc = 0; S.tokens = cfg.tokens; S.money = cfg.money;
  S.agents = 0; S.debt = 0; S.debtLevel = 'LOW';
  S.startTime = performance.now(); S.elapsed = 0;
  S.refactoring = false; S.autopilot = false;
  S.promptCount = 0; S.lineNum = 1;
  S.peakLocSec = 0; S.locLastSec = 0; S.locSecTimer = 0;
  S.lastFrameTime = performance.now();
  S.agentAccum = 0; S.gameOver = false;
  S.freeRefreshes = 0;
  modeEl.classList.add('hidden');
  hudMode.textContent = cfg.label;
  codeScroll.innerHTML = '';
  promptInput.disabled = false;
  promptInput.focus();
  updateHUD();
  loadBestTime();
  requestAnimationFrame(gameLoop);
}

/* ===== GAME LOOP ===== */
function gameLoop(now) {
  if (S.phase !== 'playing') return;
  const dt = (now - S.lastFrameTime) / 1000;
  S.lastFrameTime = now;
  S.elapsed = (now - S.startTime) / 1000;
  const cfg = MODES[S.mode];

  // Agent auto-generation (autopilot)
  if (S.autopilot && S.agents > 0 && !S.refactoring) {
    const agentLoc = S.agents * 25 * dt;
    S.agentAccum += agentLoc;
    if (S.agentAccum >= 1) {
      const whole = Math.floor(S.agentAccum);
      S.agentAccum -= whole;
      addLOC(whole, true);
    }
    // Agent token drain
    S.tokens -= S.agents * cfg.tokenDrain * dt;
    // Agent money drain
    S.money -= S.agents * 1.5 * dt;
  }

  // Passive money drain
  S.money -= cfg.moneyDrain * dt;

  // Technical debt passive decay
  if (!S.refactoring) {
    S.debt = Math.max(0, S.debt - 0.5 * dt);
  }

  // Refactoring
  if (S.refactoring) {
    S.debt = Math.max(0, S.debt - 15 * dt);
    if (S.debt <= 0) { S.refactoring = false; refactorBtn.classList.remove('active'); refactorBtn.textContent = '[ Refactor ]'; }
  }

  // LOC/sec tracking
  S.locSecTimer += dt;
  if (S.locSecTimer >= 1) {
    const rate = Math.round(S.locLastSec / S.locSecTimer);
    statLocSec.textContent = rate;
    if (rate > S.peakLocSec) { S.peakLocSec = rate; statPeak.textContent = rate; }
    S.locLastSec = 0;
    S.locSecTimer = 0;
  }

  // Smooth LOC display
  S.displayLoc += (S.loc - S.displayLoc) * Math.min(1, dt * 8);
  if (Math.abs(S.loc - S.displayLoc) < 1) S.displayLoc = S.loc;

  // Random system flash
  if (Math.random() < 0.003 * dt * 60) showSysFlash();

  // Clamp resources
  S.tokens = Math.max(0, S.tokens);
  S.money = Math.max(0, S.money);

  updateDebt();
  updateHUD();
  checkEndConditions();

  requestAnimationFrame(gameLoop);
}

/* ===== LOC GENERATION ===== */
function addLOC(amount, fromAgent) {
  S.loc += amount;
  S.locLastSec += amount;
  const cfg = MODES[S.mode];

  // Debt increase
  let debtInc = amount * 0.008;
  if (fromAgent) debtInc *= 1.8;
  S.debt = Math.min(100, S.debt + debtInc);

  // Token cost per LOC
  S.tokens -= amount * cfg.tokenPerLoc;

  // Add code lines
  const lines = generateCodeBatch(Math.min(amount, 20));
  appendCodeLines(lines);
}

function submitPrompt(text) {
  if (S.phase !== 'playing' || S.refactoring || S.gameOver) return;
  const cfg = MODES[S.mode];

  // Free mode: check tokens
  if (S.mode === 'free' && S.tokens <= 0) {
    startFreeWait();
    return;
  }

  S.promptCount++;
  statPrompts.textContent = S.promptCount;

  // Token cost for submit
  S.tokens -= cfg.tokenPerPrompt;

  // LOC calculation
  const base = 50;
  const charBonus = text.length * 2;
  const rand = 10 + Math.floor(Math.random() * 91);
  let loc = base + charBonus + rand;
  if (S.agents > 0) loc *= (1 + S.agents * 0.5);
  loc = Math.floor(loc);

  addLOC(loc, false);

  // Add prompt echo
  appendCodeLines([{ type: 'comment', text: `// vibes> ${text}` }]);

  promptInput.value = '';

  // Free mode: check if out of tokens now
  if (S.mode === 'free' && S.tokens <= 0) {
    setTimeout(() => startFreeWait(), 500);
  }
}

/* ===== FREE MODE WAIT ===== */
function startFreeWait() {
  S.phase = 'waiting';
  S.waitTime = 10;
  promptInput.disabled = true;
  waitEl.classList.remove('hidden');
  waitEl.innerHTML = `
    <div class="wait-title">Rate Limited</div>
    <div class="wait-timer" id="wait-countdown">10</div>
    <div class="wait-sub">Free tier token refresh in progress...</div>
    <div class="wait-sub" style="margin-top:8px;color:#333">This is what you get for not paying</div>
  `;
  const iv = setInterval(() => {
    S.waitTime--;
    const cd = document.getElementById('wait-countdown');
    if (cd) cd.textContent = S.waitTime;
    if (S.waitTime <= 0) {
      clearInterval(iv);
      waitEl.classList.add('hidden');
      S.tokens = 200;
      S.freeRefreshes++;
      S.phase = 'playing';
      S.lastFrameTime = performance.now();
      promptInput.disabled = false;
      promptInput.focus();
      requestAnimationFrame(gameLoop);
    }
  }, 1000);
}

/* ===== CODE GENERATION ===== */
const CODE_IMPORTS = [
  `import { vibeCheck } from '@vibe/core';`,
  `import { deployToProduction } from 'yolo-ship';`,
  `import { pray } from '@devops/hope';`,
  `import { leftPad } from 'left-pad';`,
  `import * as ai from 'hallucinate-js';`,
  `import { skipTests } from '@ci/speedrun';`,
  `import { technicalDebt } from 'future-me-problem';`,
  `import { blame } from '@git/someone-else';`,
  `const { Ship, Pray, Hope } = require('startup-toolkit');`,
  `import { gaslight } from '@llm/confidence';`,
  `import type { NeverGonnaReadThis } from './types';`,
  `import { useVibes, useHallucination } from 'react-vibe-hooks';`,
  `import { YOLO_MODE } from '@config/production';`,
  `import { copilotSuggestion } from 'github-autocomplete';`,
  `import { stackOverflowCopy } from 'ctrl-c-ctrl-v';`,
  `import { ignoreLinter } from '@eslint/disable-next-line';`,
  `import { burnMoney } from '@anthropic/api-client';`,
  `import { scaleToInfinity } from 'kubernetes-vibes';`,
];

const CODE_FUNCTIONS = [
  [`function vibeCheck(code) {`, `  return code.includes('//') ? 'LGTM' : 'needs more comments';`, `}`],
  [`function deployFriday() {`, `  console.log('YOLO');`, `  return fetch('/api/prod', { method: 'YEET' });`, `}`],
  [`async function fixBug(bug) {`, `  await new Promise(r => setTimeout(r, 86400000));`, `  return 'works on my machine';`, `}`],
  [`function estimateTask() {`, `  return Math.floor(Math.random() * 20) + ' story points';`, `}`],
  [`function reviewPR(pr) {`, `  if (pr.author === 'senior') return 'LGTM';`, `  return 'nit: add semicolons';`, `}`],
  [`function handleError(err) {`, `  console.log('TODO: handle this');`, `  return null;`, `}`],
  [`function generateRevenue() {`, `  while (true) { pivot(); }`, `}`],
  [`function scaleSystem() {`, `  return addMoreMicroservices(currentCount * 2);`, `}`],
  [`async function writeTests() {`, `  // TODO: write tests`, `  // TODO: actually write tests`, `  // FIXME: seriously write tests`, `  return Promise.resolve('tests passed');`, `}`],
  [`function optimizePerformance() {`, `  cache.clear();`, `  return 'fast now, trust me';`, `}`],
];

const CODE_CLASSES = [
  [`class StartupFounder {`, `  constructor() {`, `    this.burnRate = Infinity;`, `    this.revenue = 0;`, `    this.vibes = 'immaculate';`, `  }`, `}`],
  [`class AIAgent {`, `  think() { return Math.random() > 0.5 ? 'yes' : 'also yes'; }`, `  hallucinate() { return this.think() + ' (confident)'; }`, `}`],
  [`class TechnicalDebt extends Error {`, `  constructor() {`, `    super('we will fix this later');`, `    this.priority = 'never';`, `  }`, `}`],
  [`class ProductManager {`, `  addFeature() { this.scope *= 2; }`, `  removeFeature() { throw new Error('not possible'); }`, `}`],
];

const CODE_COMMENTS = [
  `// FIXME: this works but nobody knows why`,
  `// TODO: refactor when we have time (never)`,
  `// HACK: don't touch this or everything breaks`,
  `// NOTE: written at 3am, reviewed at 3:01am`,
  `// WARNING: here be dragons (and race conditions)`,
  `// this comment is the only documentation`,
  `// I'm sorry for what you're about to read`,
  `// copilot wrote this and I'm afraid to change it`,
  `// if you're reading this, the company has failed`,
  `// dear future dev: I am so sorry`,
  `// this is O(n!) but it ships`,
  `// the tests pass if you squint`,
  `// AI-generated: do not trust`,
  `/* eslint-disable everything */`,
  `// duct tape: load-bearing comment, do not remove`,
  `// vibes-checked: true`,
];

const CODE_VARIABLES = [
  `const MAX_VIBES = Number.MAX_SAFE_INTEGER;`,
  `let techDebt = techDebt + 1; // always growing`,
  `const DEPLOY_DAY = 'Friday';`,
  `const API_KEY = 'sk-YOLO-not-a-real-key-trust-me';`,
  `let bugsFixed = 0; // aspirational`,
  `const SPRINT_VELOCITY = Math.random() * 100;`,
  `const isProduction = process.env.NODE_ENV !== 'production' ? true : true;`,
  `let coffeeCups = Infinity;`,
  `const VERSION = '0.0.1-alpha-beta-gamma-rc69';`,
  `const MEETINGS_TODAY = Math.ceil(Math.random() * 8);`,
  `var globalState = {}; // fight me`,
  `const TOKEN_PRICE = wallet.balance * 0.01; // per character`,
];

const CODE_LOGIC = [
  [`if (vibes === 'good') {`, `  ship();`, `} else {`, `  ship(); // ship anyway`, `}`],
  [`try {`, `  await deployToProduction();`, `} catch (e) {`, `  console.log('this is fine');`, `}`],
  [`while (funding > 0) {`, `  hire(10);`, `  funding -= burnRate;`, `  pivot();`, `}`],
  [`switch (mood) {`, `  case 'motivated': writeCode(); break;`, `  case 'burnt-out': watchYouTube(); break;`, `  default: openSlack();`, `}`],
  [`for (const dep of dependencies) {`, `  if (dep.vulnerable) continue; // not my problem`, `  await install(dep);`, `}`],
  [`const result = condition`, `  ? doTheThing()`, `  : doTheOtherThing(); // both are wrong`,],
];

const CODE_ONELINERS = [
  `git commit -m 'fix: fixed the fix that fixed the fix';`,
  `console.log(JSON.stringify(JSON.parse(JSON.stringify(data))));`,
  `return arr.map(x => x).filter(x => x).reduce((a, b) => a + b, 0);`,
  `const sleep = ms => new Promise(r => setTimeout(r, ms));`,
  `document.title = 'PRODUCTION IS DOWN';`,
  `fetch('/api/data').then(r => r.json()).then(d => eval(d.code));`,
  `localStorage.setItem('auth', btoa('admin:admin'));`,
  `process.exit(Math.random() > 0.5 ? 0 : 1);`,
  `rm -rf node_modules && npm install; // the universal fix`,
  `SELECT * FROM users WHERE 1=1; -- oops`,
  `kubectl delete pods --all --namespace=production;`,
  `chmod 777 /etc/shadow; // security by vibes`,
  `Object.assign(window, { __SECRET_DEBUG: true });`,
  `export default () => import('./index.js'); // circular? yes.`,
];

function generateCodeBatch(count) {
  const lines = [];
  let remaining = count;
  while (remaining > 0) {
    const r = Math.random();
    if (r < 0.12) {
      lines.push({ type: 'import', text: pick(CODE_IMPORTS) });
      remaining--;
    } else if (r < 0.30) {
      const fn = pick(CODE_FUNCTIONS);
      fn.forEach(l => lines.push({ type: 'function', text: l }));
      remaining -= fn.length;
    } else if (r < 0.38) {
      const cls = pick(CODE_CLASSES);
      cls.forEach(l => lines.push({ type: 'class', text: l }));
      remaining -= cls.length;
    } else if (r < 0.52) {
      lines.push({ type: 'comment', text: pick(CODE_COMMENTS) });
      remaining--;
    } else if (r < 0.65) {
      lines.push({ type: 'variable', text: pick(CODE_VARIABLES) });
      remaining--;
    } else if (r < 0.80) {
      const logic = pick(CODE_LOGIC);
      logic.forEach(l => lines.push({ type: 'logic', text: l }));
      remaining -= logic.length;
    } else {
      lines.push({ type: 'oneliner', text: pick(CODE_ONELINERS) });
      remaining--;
    }
  }
  return lines;
}

function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

function highlightCode(text) {
  let h = text
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/(\/\/.*|\/\*.*?\*\/|#\s.*)/g, '<span class="cmt">$1</span>')
    .replace(/\b(function|const|let|var|import|export|from|return|if|else|while|for|switch|case|break|default|class|extends|constructor|async|await|try|catch|throw|new|typeof|require|type)\b/g, '<span class="kw">$1</span>')
    .replace(/('(?:[^'\\]|\\.)*'|"(?:[^"\\]|\\.)*"|`(?:[^`\\]|\\.)*`)/g, '<span class="str">$1</span>')
    .replace(/\b(\d+(?:\.\d+)?)\b/g, '<span class="num">$1</span>');
  return h;
}

function appendCodeLines(lines) {
  lines.forEach((line, i) => {
    const div = document.createElement('div');
    div.className = 'code-line';
    div.innerHTML = `<span class="line-num">${String(S.lineNum).padStart(4, ' ')}</span>${highlightCode(line.text)}`;
    div.style.animationDelay = `${i * 40}ms`;
    codeScroll.appendChild(div);
    S.lineNum++;
  });
  // Keep scrolled to bottom
  codeScroll.scrollTop = codeScroll.scrollHeight;
  // Trim old lines for performance
  while (codeScroll.children.length > 500) {
    codeScroll.removeChild(codeScroll.firstChild);
  }
}

/* ===== AGENTS ===== */
function deployAgent() {
  if (S.agents >= 16 || S.money < 500 || S.phase !== 'playing') return;
  S.money -= 500;
  S.agents++;
  agentCount.textContent = `Agents: ${S.agents} / 16`;
  hudAgents.textContent = `${S.agents}/16`;
  updateHUD();

  // Polecat flash
  showPolecat();
}

function showPolecat() {
  polecatEl.classList.remove('hidden');
  polecatEl.innerHTML = '<div class="flash-text">Yegge Polecat Mode Enabled!</div>';
  setTimeout(() => {
    polecatEl.classList.add('hidden');
    showGasTown();
  }, 2000);
}

function showGasTown() {
  gastownEl.classList.remove('hidden');
  gastownEl.innerHTML = `<div class="gas-label">Approaching Gas Town...</div><div class="gas-num">5</div>`;
  let count = 5;
  const iv = setInterval(() => {
    count--;
    if (count > 0) {
      gastownEl.querySelector('.gas-num').textContent = count;
      gastownEl.querySelector('.gas-num').style.animation = 'none';
      void gastownEl.querySelector('.gas-num').offsetHeight;
      gastownEl.querySelector('.gas-num').style.animation = 'gas-scale 1s ease-out';
    } else {
      clearInterval(iv);
      gastownEl.classList.add('hidden');
      S.autopilot = true;
      autopilotStatus.textContent = 'AUTOPILOT: ON';
      autopilotStatus.classList.add('autopilot-on');
    }
  }, 1000);
}

/* ===== TECHNICAL DEBT ===== */
function updateDebt() {
  const d = Math.min(100, Math.max(0, S.debt));
  S.debt = d;
  let level, color;
  if (d < 25)      { level = 'LOW';      color = 'var(--debt-low)'; }
  else if (d < 50) { level = 'MODERATE';  color = 'var(--debt-mod)'; }
  else if (d < 75) { level = 'HIGH';      color = 'var(--debt-high)'; }
  else             { level = 'CRITICAL';  color = 'var(--debt-crit)'; }
  S.debtLevel = level;
  debtBar.style.width = d + '%';
  debtBar.style.background = color;
  debtLabel.textContent = level;
  debtLabel.style.color = color;
  debtPct.textContent = Math.round(d) + '%';
  if (d >= 75) { debtSection.classList.add('debt-critical'); }
  else { debtSection.classList.remove('debt-critical'); }
}

function toggleRefactor() {
  if (S.phase !== 'playing') return;
  S.refactoring = !S.refactoring;
  if (S.refactoring) {
    refactorBtn.classList.add('active');
    refactorBtn.textContent = '[ Refactoring... ]';
  } else {
    refactorBtn.classList.remove('active');
    refactorBtn.textContent = '[ Refactor ]';
  }
}

/* ===== HUD UPDATE ===== */
function updateHUD() {
  const mins = Math.floor(S.elapsed / 60);
  const secs = Math.floor(S.elapsed % 60);
  hudTime.textContent = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
  hudLoc.textContent = formatNum(Math.floor(S.displayLoc));
  hudTokens.textContent = formatNum(Math.floor(S.tokens));
  hudMoney.textContent = '$' + formatNum(Math.floor(S.money));
  hudAgents.textContent = `${S.agents}/16`;
  deployBtn.disabled = S.agents >= 16 || S.money < 500;
}

function formatNum(n) {
  if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
  return String(n);
}

/* ===== END CONDITIONS ===== */
function checkEndConditions() {
  if (S.gameOver) return;
  const cfg = MODES[S.mode];

  // Victory: reach goal
  if (S.loc >= cfg.goal) {
    S.gameOver = true;
    S.phase = 'victory';
    showVictory();
    return;
  }

  // Project failure: debt >= 100
  if (S.debt >= 100) {
    S.gameOver = true;
    S.phase = 'failure';
    showFailure('TECHNICAL DEBT REACHED 100%');
    return;
  }

  // Out of tokens (non-free modes)
  if (S.mode !== 'free' && S.tokens <= 0 && !S.autopilot) {
    S.gameOver = true;
    S.phase = 'failure';
    showFailure('OUT OF TOKENS');
    return;
  }

  // Out of money
  if (S.money <= 0 && S.mode !== 'free') {
    S.gameOver = true;
    S.phase = 'failure';
    showFailure('OUT OF MONEY — STARTUP IMPLODED');
    return;
  }
}

/* ===== VICTORY ===== */
function showVictory() {
  promptInput.disabled = true;
  const time = formatTime(S.elapsed);
  saveBestTime(S.elapsed);
  victoryEl.classList.remove('hidden');
  victoryEl.innerHTML = `
    <div class="victory-title">1,000,000 LOC REACHED!</div>
    <div class="victory-stat">Time: ${time}</div>
    <div class="victory-stat">Prompts: ${S.promptCount}</div>
    <div class="victory-stat">Agents: ${S.agents}</div>
    <div class="victory-stat">Peak LOC/s: ${S.peakLocSec}</div>
    <div class="victory-stat">Technical Debt: ${Math.round(S.debt)}%</div>
    <div class="victory-stat" style="color:#555;margin-top:6px;font-size:0.5rem">None of this code works. You know that, right?</div>
    <button class="victory-btn" id="victory-restart">[ Play Again ]</button>
  `;
  document.getElementById('victory-restart').addEventListener('click', restart);
}

/* ===== FAILURE ===== */
function showFailure(reason) {
  promptInput.disabled = true;
  failureEl.classList.remove('hidden');
  failureEl.innerHTML = `
    <div class="fail-title">PROJECT FAILURE</div>
    <pre class="fail-art">
    ╔══════════════════════════════╗
    ║  STACK TRACE:                ║
    ║  at VibeCorp.deploy()        ║
    ║  at Agent.hallucinate()      ║
    ║  at Promise.&lt;rejected&gt;       ║
    ║  at RunLoop.panic()          ║
    ║  at Process.exit(1)          ║
    ╚══════════════════════════════╝
    </pre>
    <div class="fail-stat">Reason: ${reason}</div>
    <div class="fail-stat">LOC Written: ${formatNum(Math.floor(S.loc))}</div>
    <div class="fail-stat">Time: ${formatTime(S.elapsed)}</div>
    <div class="fail-stat">Prompts: ${S.promptCount}</div>
    <div class="fail-stat" style="color:#660000;margin-top:6px;font-size:0.5rem">The investors are not pleased.</div>
    <button class="fail-btn" id="fail-restart">[ Try Again ]</button>
  `;
  document.getElementById('fail-restart').addEventListener('click', restart);
}

function restart() {
  victoryEl.classList.add('hidden');
  failureEl.classList.add('hidden');
  S.phase = 'modeselect';
  showModeSelect();
}

/* ===== SYSTEM FLASH ===== */
const SYS_MESSAGES = [
  'CODE REVIEW: SKIPPED (VIBES INTACT)',
  'npm audit: 2,451 VULNERABILITIES (SHIP IT)',
  'COPILOT CONFIDENCE: 97% (ACCURACY: 12%)',
  'PROD INCIDENT #4,829 — AUTO-RESOLVED (IGNORED)',
  'JIRA TICKET CREATED: "INVESTIGATE LATER"',
  'HALLUCINATION DETECTED — PROMOTING TO FEATURE',
  'TECH DEBT INTEREST PAYMENT: $4,200/mo',
  'UNIT TEST COVERAGE: NaN%',
  'DEPLOYING TO PROD... LGTM',
  'MERGE CONFLICT RESOLVED BY DELETING BOTH VERSIONS',
  'SPRINT RETRO: "WE NEED MORE AGENTS"',
  'TOKEN BURN RATE: FINANCIALLY IRRESPONSIBLE',
  'SECURITY SCAN: EVERYTHING IS FINE (IT IS NOT FINE)',
  'MONITORING ALERT: CPU AT 420% — VIBES NOMINAL',
  'GIT BLAME: EVERYONE',
  'DOCUMENTATION: 404 NOT FOUND',
  'PERFORMANCE REVIEW: "SHIPS FAST, BREAKS FASTER"',
  'KUBERNETES CLUSTER: 47 PODS FOR A TODO APP',
  'ESTIMATED COMPLETION: 2 WEEKS (ACTUAL: HEAT DEATH OF UNIVERSE)',
  'TECHNICAL INTERVIEW: "JUST VIBE IT OUT"',
];

function showSysFlash(msg) {
  const text = msg || pick(SYS_MESSAGES);
  sysFlash.textContent = text;
  sysFlash.classList.add('show');
  clearTimeout(S.flashTimer);
  S.flashTimer = setTimeout(() => sysFlash.classList.remove('show'), 1800);
}

/* ===== LOCAL STORAGE ===== */
function saveBestTime(elapsed) {
  const key = 'vibe-racer-best-' + S.mode;
  const prev = parseFloat(localStorage.getItem(key));
  if (!prev || elapsed < prev) localStorage.setItem(key, elapsed);
}
function loadBestTime() {
  const key = 'vibe-racer-best-' + S.mode;
  const val = parseFloat(localStorage.getItem(key));
  statBest.textContent = val ? formatTime(val) : '--:--';
}
function formatTime(s) {
  const m = Math.floor(s / 60);
  const sec = Math.floor(s % 60);
  return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}

/* ===== EVENT LISTENERS ===== */
promptInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && promptInput.value.trim()) {
    submitPrompt(promptInput.value.trim());
  }
});

refactorBtn.addEventListener('click', toggleRefactor);
deployBtn.addEventListener('click', deployAgent);

/* ===== INIT ===== */
runBoot();
</script>
</body>
</html>
